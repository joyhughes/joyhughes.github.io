<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCD Matrix Calculator (File Upload)</title>
    <style>
        #dropZone {
            width: 300px;
            height: 150px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            cursor: pointer;
        }
        #dropZone.dragover {
            border-color: #000;
        }
        #progress {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
        }
        pre {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>NCD Matrix Calculator (File Upload)</h1>
    <div id="dropZone">Drag & Drop Text Files Here</div>

    <h2>Progress:</h2>
    <div id="progress"></div>

    <h2>Result:</h2>
    <pre id="result"></pre>

    <!-- Web Worker Script -->
    <script type="text/javascript">
        // Define the web worker code as a Blob
        const workerCode = `
            async function compressedSize(blob) {
                const stream = blob.stream();
                const compressionStream = new CompressionStream("gzip");
                const compressedStream = stream.pipeThrough(compressionStream);
                const response = new Response(compressedStream);
                const compressedBlob = await response.blob();
                return compressedBlob.size;
            }

            async function compressedSizePair(str1, str2) {
                const blob = new Blob([str1, str2]);
                return await compressedSize(blob);
            }

            async function compressedSizeSingle(str) {
                const blob = new Blob([str]);
                return await compressedSize(blob);
            }

            function calculateNCD(sizeX, sizeY, sizeXY) {
                return (sizeXY - Math.min(sizeX, sizeY)) / Math.max(sizeX, sizeY);
            }

            self.onmessage = async function (e) {
                const { labels, contents } = e.data;
                const n = contents.length;
                const singleCompressedSizes = new Array(n);
                const ncdMatrix = Array.from({ length: n }, () => Array(n).fill(0));

                // Step 1: Precompute single compressed sizes
                for (let i = 0; i < n; i++) {
                    singleCompressedSizes[i] = await compressedSizeSingle(contents[i]);
                }

                // Step 2: Compute pairwise compressed sizes and NCD values
                for (let i = 0; i < n; i++) {
                    for (let j = i; j < n; j++) {
                        let ncd = 0;
                        if (i !== j) {
                            const sizeXY = await compressedSizePair(contents[i], contents[j]);
                            ncd = calculateNCD(singleCompressedSizes[i], singleCompressedSizes[j], sizeXY);
                        }
                        ncdMatrix[i][j] = ncd;
                        ncdMatrix[j][i] = ncd; // Symmetric matrix

                        // Send progress update for the current cell
                        self.postMessage({ type: 'progress', i, j, value: ncd });
                    }
                }

                // Send the final NCD matrix
                self.postMessage({ type: 'result', labels, ncdMatrix });
            };
        `;

        // Create a Blob URL for the worker code
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const workerURL = URL.createObjectURL(blob);
        const worker = new Worker(workerURL);

        // Variables to hold file contents and labels
        let fileContents = [];
        let fileLabels = [];

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', async (event) => {
            event.preventDefault();
            dropZone.classList.remove('dragover');

            // Get newly dropped files
            const files = Array.from(event.dataTransfer.files);
            if (files.length > 0) {
                // Process each dropped file
                for (let file of files) {
                    const content = await file.text();
                    const lines = content.split('\n');
                    if (lines.length > 1) {
                        const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, ''); // Remove extension from filename
                        fileLabels.push(fileNameWithoutExt); // Use file name (without extension) as label
                        fileContents.push(lines.slice(1).join('\n')); // Use the rest for compression
                    }
                }

                // Start NCD calculation
                runNCDWorker();
            }
        });

        // Function to run the NCD worker
        function runNCDWorker() {
            if (fileContents.length === 0) {
                alert('Please drag and drop at least one valid text file.');
                return;
            }

            // Clear previous progress and result
            document.getElementById('progress').textContent = '';
            document.getElementById('result').textContent = '';

            // Set up worker message handler
            worker.onmessage = function (e) {
                const message = e.data;
                
                if (message.type === 'progress') {
                    // Update progress
                    const { i, j, value } = message;
                    const progressDiv = document.getElementById('progress');
                    const progressText = `Cell [${i}, ${j}] = ${value}`;
                    const progressEntry = document.createElement('div');
                    progressEntry.textContent = progressText;
                    progressDiv.appendChild(progressEntry);
                    progressDiv.scrollTop = progressDiv.scrollHeight; // Auto-scroll to the latest entry

                } else if (message.type === 'result') {
                    // Display the final NCD matrix in the specified format
                    const { labels, ncdMatrix } = message;
                    let matrixString = '';

                    for (let i = 0; i < ncdMatrix.length; i++) {
                        matrixString += labels[i] + ' ' + ncdMatrix[i].join(' ') + '\n';
                    }

                    document.getElementById('result').textContent = matrixString;
                }
            };

            // Send data to worker
            worker.postMessage({ labels: fileLabels, contents: fileContents });
        }
    </script>
</body>
</html>
